
#include "utils.h"

#ifndef NULL
#define NULL (void*)0
#endif

//Modbus CRC校验查表法
static const unsigned char auchCRCHi[] = {//高位字节表
0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 
0x40, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0,
0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 
0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41,
0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 
0x40, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0,
0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 
0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40,
0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 
0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0,
0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 
0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41,
0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 
0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0,
0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 
0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41,
0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 
0x40
};
//*****************************************************************************
//低位字节表
static const unsigned char auchCRCLo[] = {//Modbus CRC校验查表法
0x00, 0xC0, 0xC1, 0x01, 0xC3, 0x03, 0x02, 0xC2, 0xC6, 0x06, 0x07, 0xC7, 0x05, 0xC5, 0xC4, 
0x04, 0xCC, 0x0C, 0x0D, 0xCD, 0x0F, 0xCF, 0xCE, 0x0E, 0x0A, 0xCA, 0xCB, 0x0B, 0xC9, 0x09,
0x08, 0xC8, 0xD8, 0x18, 0x19, 0xD9, 0x1B, 0xDB, 0xDA, 0x1A, 0x1E, 0xDE, 0xDF, 0x1F, 0xDD, 
0x1D, 0x1C, 0xDC, 0x14, 0xD4, 0xD5, 0x15, 0xD7, 0x17, 0x16, 0xD6, 0xD2, 0x12, 0x13, 0xD3,
0x11, 0xD1, 0xD0, 0x10, 0xF0, 0x30, 0x31, 0xF1, 0x33, 0xF3, 0xF2, 0x32, 0x36, 0xF6, 0xF7, 
0x37, 0xF5, 0x35, 0x34, 0xF4, 0x3C, 0xFC, 0xFD, 0x3D, 0xFF, 0x3F, 0x3E, 0xFE, 0xFA, 0x3A,
0x3B, 0xFB, 0x39, 0xF9, 0xF8, 0x38, 0x28, 0xE8, 0xE9, 0x29, 0xEB, 0x2B, 0x2A, 0xEA, 0xEE, 
0x2E, 0x2F, 0xEF, 0x2D, 0xED, 0xEC, 0x2C, 0xE4, 0x24, 0x25, 0xE5, 0x27, 0xE7, 0xE6, 0x26,
0x22, 0xE2, 0xE3, 0x23, 0xE1, 0x21, 0x20, 0xE0, 0xA0, 0x60, 0x61, 0xA1, 0x63, 0xA3, 0xA2, 
0x62, 0x66, 0xA6, 0xA7, 0x67, 0xA5, 0x65, 0x64, 0xA4, 0x6C, 0xAC, 0xAD, 0x6D, 0xAF, 0x6F,
0x6E, 0xAE, 0xAA, 0x6A, 0x6B, 0xAB, 0x69, 0xA9, 0xA8, 0x68, 0x78, 0xB8, 0xB9, 0x79, 0xBB, 
0x7B, 0x7A, 0xBA, 0xBE, 0x7E, 0x7F, 0xBF, 0x7D, 0xBD, 0xBC, 0x7C, 0xB4, 0x74, 0x75, 0xB5,
0x77, 0xB7, 0xB6, 0x76, 0x72, 0xB2, 0xB3, 0x73, 0xB1, 0x71, 0x70, 0xB0, 0x50, 0x90, 0x91, 
0x51, 0x93, 0x53, 0x52, 0x92, 0x96, 0x56, 0x57, 0x97, 0x55, 0x95, 0x94, 0x54, 0x9C, 0x5C,
0x5D, 0x9D, 0x5F, 0x9F, 0x9E, 0x5E, 0x5A, 0x9A, 0x9B, 0x5B, 0x99, 0x59, 0x58, 0x98, 0x88, 
0x48, 0x49, 0x89, 0x4B, 0x8B, 0x8A, 0x4A, 0x4E, 0x8E, 0x8F, 0x4F, 0x8D, 0x4D, 0x4C, 0x8C,
0x44, 0x84, 0x85, 0x45, 0x87, 0x47, 0x46, 0x86, 0x82, 0x42, 0x43, 0x83, 0x41, 0x81, 0x80, 
0x40
};
////////////////////////////////////////////
unsigned short int  Modbus_CRC16(unsigned char *ptRingBuf,unsigned short int ucData)//CRC校验
{
	unsigned short int uli;    
	unsigned char uchCRCHi = 0xFF ;    // 高CRC字节初始化
  unsigned char uchCRCLo = 0xFF ;    // 低CRC 字节初始化
	unsigned char uIndex ;             // CRC循环中的索引
	
	for (uli=0; uli<ucData; uli++)
	{
		uIndex = uchCRCHi ^ *ptRingBuf++ ; // 计算CRC

		uchCRCHi = uchCRCLo ^ auchCRCHi[uIndex];
    	uchCRCLo = auchCRCLo[uIndex] ;
	}
	return (uchCRCLo << 8 | uchCRCHi) ;
}

//////////////////////////////////////////////////////////////////////////
void CharToHex_String(char * src, char * dest, unsigned int destlen) 
{ 
  char * srcptr; 
  srcptr = src; 
  while(destlen--) 
  { 
    *dest = CharToHex(*srcptr++) << 4; 
    *dest++ += CharToHex(*srcptr++); 
  } 
}

//////////////////////////////////////////////////////////////////////////
unsigned char HexToChar(unsigned char bHex)
{
  if((bHex<=9))  //
  {
    bHex += 0x30;
  }
  else if((bHex>=10)&&(bHex<=15))//Capital
  {
    bHex += 0x37;
  }
  else 
  {
    bHex = 0xff;
  }
  return bHex;

}

//////////////////////////////////////////////////////////////////////////
void HexArrayToString(unsigned char *data,unsigned char hex_length,char *string)
{
  unsigned char i = 0;
  
  for(i=0; i<hex_length; i++)
  {
    string[2*i] = HexToChar(data[i]>>4);
    string[2*i+1] = HexToChar(data[i]&0xf);		 
  }
  
}
//////////////////////////////////////////////////////////////////////////
unsigned char CharToHex(char ch) //???HEX
{ 
  if (ch >= '0' && ch <= '9') 
  {
    return (ch - '0'); 
  }
  if (ch >= 'A' && ch <= 'F')
  {
    return (ch - 'A' + 0xA); 
  }
  if (ch >= 'a' && ch <= 'f') 
  {
    return (ch - 'a' + 0xA); 
  }
  return 0; 
} 

/////////////////////////////////////////////////////////////////////////////
unsigned char bcd_to_hex(unsigned char bcd)
{
    unsigned char hex;
    hex = bcd >> 4;//取高4位
    hex *= 10;     //乘以权值
    bcd &= 0x0f;   //取低4位
    hex += bcd;    //合并数据
    return (hex);
}

/////////////////////////////////////////////////////////////////////////////
unsigned char hex_to_bcd(unsigned char hex)
{
    unsigned char bcd;
    bcd = hex/10;
    bcd = bcd<<4;
    bcd = bcd + hex%10;
    return (bcd);	
}

void str_replace(char *str)
{
	unsigned int len = strlen(str);//计算当前输入字符串长度
	
	unsigned int replace_num = 0;//
	
	char *end = NULL;
	char *end_new = NULL;
	char *pstr = str;//p指向字符串
	
	while (*str++ != '\0')//遍历字符串
	{
		if (*str == '\"')//索引到目标字符
		{
			replace_num++; //目标字符计数器+1
		}
	}
	end = str;//字符串指向p
	end_new =end + 2 * replace_num;//计算新长度 
	str=pstr;

	while (end != end_new)//当新结束指针和原结束指针不相等时 
	{
		if (*end == '\"')//发现"\""，变为"\22"
		{
			*end_new-- = '2';
			*end_new-- = '2';
			*end_new-- = '\\';
			 end--;
		}
		else
		{
			*end_new-- = *end--;
		}
	}
}


// 函数输入ascii字符串，输出对应的16进制字符串 
void chstohex_for_modify(char *str, unsigned char *strhex,unsigned int spec_strlen)//指定长度
{

	unsigned char i,cnt=0;
	char *p = str;             //直针p初始化为指向str
	unsigned char len = spec_strlen; //获取字符串中的字符个数
	
	while(*p != '\0') 
	{        //结束符判断
		for (i = 0; i < len; i ++)  //循环判断当前字符是数字还是小写字符还是大写字母
		{
			if ((*p >= '0') && (*p <= '9')) //当前字符为数字0~9时
				strhex[cnt] = *p - '0' + 0x30;//转为十六进制
			
			if ((*p >= 'A') && (*p <= 'Z')) //当前字符为大写字母A~Z时
				strhex[cnt] = *p - 'A' + 0x41;//转为十六进制
			
			if ((*p >= 'a') && (*p <= 'z')) //当前字符为小写字母a~z时
				strhex[cnt] = *p - 'a' + 0x61;  //转为十六进制
			
			/*特殊字符*/
//			if(*p == '"') strhex[cnt] = *p - '"' + 0x22;  //转为十六进制					
			if(*p == '#') strhex[cnt] = *p - '#' + 0x23;  //转为十六进制					
			if(*p == '$') strhex[cnt] = *p - '$' + 0x24;  //转为十六进制				
			if(*p == '%') strhex[cnt] = *p - '%' + 0x25;  //转为十六进制					
			if(*p == '-') strhex[cnt] = *p - '_' + 0x2D;  //转为十六进制			
			if(*p == '.') strhex[cnt] = *p - '.' + 0x2E;  //转为十六进制					
			if(*p == '/') strhex[cnt] = *p - '/' + 0x2F;  //转为十六进制				
			if(*p == '\\') strhex[cnt] = *p - '\\' + 0x5C;  //转为十六进制					
			if(*p == '_') strhex[cnt] = *p - '_' + 0x5F;  //转为十六进制
			if(*p == '@') strhex[cnt] = *p - '@' + 0x40;  //转为十六进制					
			if(*p == '~') strhex[cnt] = *p - '~' + 0x7E;  //转为十六进制				
//      if(*p == '{') strhex[cnt] = *p - '{' + 0x7B;  //转为十六进制
//      if(*p == '}') strhex[cnt] = *p - '}' + 0x7D;  //转为十六进制				
			p ++;    //指向下一个字符
			cnt ++;  
		}
	}
}

// 函数输入16进制字符串，输出对应的字符串
void hextochs_mofify(unsigned char *hexstr, char *ascstr,unsigned int spec_hexlen)
{
	for(unsigned int i=0;i<spec_hexlen;i++)
	{
		if((hexstr[i]>=0x30) && (hexstr[i]<=0x39))
		{
			ascstr[i]=hexstr[i]-0x30 +'0';
		}
		
		if((hexstr[i]>=0x41) && (hexstr[i]<=0x5A))
		{
			ascstr[i]=hexstr[i]-0x41 +'A';
		}	
		
		if((hexstr[i]>=0x61) && (hexstr[i]<=0x7A))
		{
			ascstr[i]=hexstr[i]-0x61 +'a';
		}		
		/*特殊字符*/
    if(hexstr[i]==0x23)	 	 ascstr[i]='#';
    if(hexstr[i]==0x24)	 	 ascstr[i]='$';
    if(hexstr[i]==0x25)	 	 ascstr[i]='%';
    if(hexstr[i]==0x2D)	 	 ascstr[i]='_';
    if(hexstr[i]==0x2E)	 	 ascstr[i]='.';
    if(hexstr[i]==0x2F)	 	 ascstr[i]='/';
    if(hexstr[i]==0x5C)	 	 ascstr[i]='\\';		
    if(hexstr[i]==0x5F)	 	 ascstr[i]='_';
    if(hexstr[i]==0x40)	 	 ascstr[i]='@';
    if(hexstr[i]==0x7E)	 	 ascstr[i]='~';				
  }
}
